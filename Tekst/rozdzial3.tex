
\chapter{Wspó³praca mikrokontrolerów z urz±dzeniami zewnêtrznymi}


\section{Wiadomo¶ci ogólne}

\begin{figure}
\begin{centering}
\includegraphics{rys/interfejsy/wspolpraca_z_urz_zew}
\par\end{centering}

\caption{Wspó³praca mikrokontrolera z urz±dzeniem zewnêtrznym (\emph{¬ród³o:}
\cite{Krzyzanowski207})}


\end{figure}


Mikrokomputery komunikuj± siê z urz±dzeniami peryferyjnymi poprzez
tzw. interfejsy. Przez interfejs rozumie siê urz±dzenie, które pozwala
na komunikacjê i wymianê danych pomiêdzy dwoma innymi urz±dzeniami.
Istniej± ró¿ne kryteria podzia³u interfejsów \cite{Krzyzanowski207}:
\begin{itemize}
\item ze wzglêdu na istnienie fizycznego po³±czenia miêdzy komunikuj±cymi
siê urz±dzeniami:

\begin{itemize}
\item przewodowe (np. UART, I2C, FireWire (IEEE 1394), RS-232), w których
rolê sygna³ów pe³ni± napiêcie lub pr±d, za¶ rolê medium przewody,
\item bezprzewodowe (np. Bluetooth, IrDA, WiFi), w których sygna³ami s±
fale elektromagnetyczne, za¶ medium najczê¶ciej powietrze;
\end{itemize}
\item ze wzglêdu na ilo¶æ danych (bitów) przesy³anych w trakcie elementarnego
cyklu transmisji:

\begin{itemize}
\item szeregowe (np. SPI, UART, I2C), w których dane s± transmitowane bit
po bicie,
\item równoleg³e (np. GPIB, SCSI, ATA oraz u¿ywany kiedy¶ w drukarkach interfejs
Centronics);
\end{itemize}
\item ze wzglêdu na charakter sygna³ów:

\begin{itemize}
\item analogowe (np. Jack, S-Video),
\item cyfrowe (np. SPI, I2C, USB).
\end{itemize}
\end{itemize}
Pod pojêciem interfejsu przewodowego rozumie siê z³±cza oraz przewody
³±cz±ce urz±dzenie zewnêtrzne z mikrokomputerem wraz z ich specyfikacj±
mechaniczn± (kszta³t, rozmiar, ilo¶æ) oraz charakterystykami elektrycznymi
sygna³ów (poziomy napiêæ i pr±dów, relacje czasowe). Aby przesy³ sygna³ów
by³ mo¿liwy, zwi±zany z nimi obwód elektryczny musi byæ zamkniêty,
dlatego sk³ada siê z dwóch przewodów tworz±cych liniê. Istniej± linie
symetryczne i niesymetryczne. Schemat obu pokazano na rysunku \ref{fig:Linie-transmisyjne}.
\begin{figure}
\begin{centering}
\includegraphics{rys/interfejsy/linie}
\par\end{centering}

\caption{Linie transmisyjne: a) niesymetryczna, b) symetryczna (\emph{¬ród³o:}
\cite{Krzyzanowski207}) \label{fig:Linie-transmisyjne}}


\end{figure}


Linia niesymetryczna sk³ada siê z przewodu sygna³owego (zwanego tak¿e
gor±cym) oraz masowego, stanowi±cego referencjê dla sygna³u po obu
stronach toru transmisyjnego. W sytuacji gdy w transmisji u¿ywa siê
wiêcej ni¿ jednego sygna³u, mo¿liwe jest zastosowanie wspólnego przewodu
powrotnego \cite{Krzyzanowski207}. Linie niesymetryczne s± s³abo
odporne na dzia³anie obcych pól elektromagnetycznych. Powoduj± one
indukowanie siê zak³óceñ, które dodaj± siê lub odejmuj± od w³a¶ciwego
sygna³u na wej¶ciu odbiornika. Z tego powodu linie tego typu stosuje
siê do przesy³u danych na niedu¿e odleg³o¶ci. W celu zmniejszenia
wp³ywu zewnêtrznych pól, stosuje siê nastêpuj±ce zabiegi:
\begin{itemize}
\item skrêcanie przewodów,
\item ekranowanie linii.
\end{itemize}
Linia symetryczna sk³ada siê z dwóch przewodów wiod±cych sygna³y znajduj±ce
siê w przeciwfazie oraz odbiornika z wej¶ciem ró¿nicowym. Dziêki temu,
sygna³y o takich samych przebiegach indukowane w~poszczególnych przewodach
znosz± siê po odjêciu na wej¶ciu wzmacniacza. W celu zapewnienia lepszej
ochrony przed zak³óceniami mo¿liwe jest równie¿ skrêcanie przewodów.
Zasiêg linii symetrycznych jest du¿o wiêkszy ni¿ w przypadku linii
niesymetrycznych i osi±ga rz±d 1 km \cite{Krzyzanowski207}.

Najbardziej odpornym na zak³ócenia elektromagnetyczne medium jest
¶wiat³owód. Pozwala on na transmisjê na bardzo du¿e odleg³o¶ci (od
kilku do kilkudziesiêciu kilometrów). Tor ¶wiat³owodowy wymaga zastosowania
nadajnika przekszta³caj±cego sygna³ elektryczny na impulsy ¶wietlne,
w³a¶ciwego ¶wiat³owodu (wykonanego zwykle z w³ókna szklanego) oraz
odbiornika realizuj±cego odwrotn± konwersjê sygna³ów.


\subsection{Transmisja szeregowa i równoleg³a}

Transmisja szeregowa polega na przesy³aniu informacji bit po bicie.
Oznacza to, ¿e w elementarnym cyklu transmisji nadajnik wysy³a jeden
bit, za¶ odbiornik go odbiera. Zalet± takiego rozwi±zania jest stosunkowo
niewielka ilo¶æ u¿ytych przewodów. Liczba ta jest wiêksza w przypadku
transmisji równoleg³ej, w której na raz mo¿liwe jest przesy³anie wiêkszej
ilo¶ci bitów (ka¿dy swoim torem). Teoretycznie podnosi to szybko¶æ
transferu danych, jednak w praktyce jest ona ograniczona ze wzglêdu
na zak³ócanie sygna³ów przez pola pochodz±ce od s±siednich linii danych.
Inn± wad± tego typu komunikacji jest tak¿e stosunkowo skomplikowana
budowa (a co za tym idzie wiêkszy koszt) interfejsów równoleg³ych.
Uzasadnia to fakt wykorzystania przez wiêkszo¶æ wspó³czesnych urz±dzeñ
cyfrowych interfejsów i~transmisji szeregowych.

\begin{figure}
\begin{centering}
\includegraphics{rys/interfejsy/transmisja_szeregowa}
\par\end{centering}

\caption{Uk³ad transmisji szeregowej (\emph{¬ród³o:} \cite{Krzyzanowski207})
\label{fig:Uklad-transmisji-szeregowej}}
\end{figure}


Rysunek \ref{fig:Uklad-transmisji-szeregowej} przedstawia uproszczony
schemat uk³adu transmisji szeregowej. Dziêki obecno¶ci dwóch przewodów
sygna³owych, mo¿liwa jest komunikacja w trybie dupleks (ang. \emph{full
duplex}), pozwalaj±ca na jednoczesn± wymianê danych przez komunikuj±ce
siê urz±dzenia. Sygna³ nadawany (TxD) wysy³any jest do portu odbieraj±cego
dane (RxD). Urz±dzenia uczestnicz±ce w komunikacji wyposa¿one s± zarówno
w nadajnik jak i odbiornik.

Prócz transmisji dupleksowej, w uk³adach cyfrowych mo¿liwe s± równie¿
jeszcze dwa inne tryby wymiany danych:
\begin{itemize}
\item pó³dupleks (ang. \emph{half duplex}) - pozwalaj±cy na obustronn±,
lecz nie jednoczesn± wymianê danych,
\item simpleks (ang. \emph{simplex}) - pozwalaj±cy na przesy³ danych tylko
w jednym kierunku.
\end{itemize}
Dane wysy³ane szeregowo s± czêsto przechowywane w rejestrach. Aby
umo¿liwiæ transmisjê bit po bicie stosuje siê rejestry przesuwne lub
multipleksery. W obu przypadkach nale¿y zdefiniowaæ czas transmisji
pojedynczego bitu \cite{Krzyzanowski207}. S³u¿y do tego sygna³ zegarowy
nadajnika. Odbiornik okre¶la warto¶æ danego bitu w po³owie czasu jego
trwania. Istniej± dwa rodzaje transmisji szeregowej:
\begin{itemize}
\item transmisja asynchroniczna,
\item transmisja synchroniczna.
\end{itemize}

\subsection{Transmisja asynchroniczna i synchroniczna}

W przypadku transmisji asynchronicznej zegary nadajnika i odbiornika
nie s± synchronizowane. Dane nie musz± byæ przesy³ane w sposób ci±g³y,
tzn. miêdzy kolejnymi transmisjami, linia danych znajduje siê w stanie
spoczynku przez tzw. czas martwy. Dane przesy³ane nosz± w literaturze
nazwê znaku i~sk³adaj± siê zwykle z od piêciu do o¶miu bitów. Aby
odbiornik móg³ wykryæ pocz±tek oraz koniec nadawania danych, ka¿dy
znak poprzedzony jest tzw. bitem startu oraz zakoñczony tzw. bitami
stopu (od jednego do dwóch). Dodatkowo w celu zapewnienia poprawno¶ci
transmisji stosuje siê równie¿ tzw. bit parzysto¶ci. Wad± transmisji
asynchronicznej jest istnienie czasu martwego, zmniejszaj±cego efektywno¶æ
przesy³u danych. Suma liczby jedynek tworz±cych znak wraz z bitem
parzysto¶ci powinna tworzyæ liczbê parzyst±.

\begin{figure}
\begin{centering}
\includegraphics{rys/interfejsy/transmisja_szeregowa_asynchroniczna}
\par\end{centering}

\caption{Przebieg sygna³u w transmisji szeregowej asynchronicznej (\emph{¬ród³o:}
\cite{Krzyzanowski207})}


\end{figure}


Przed w³a¶ciw± komunikacj± nale¿y ustaliæ jej nastêpuj±ce parametry:
\begin{itemize}
\item czêstotliwo¶æ zegarów,
\item d³ugo¶æ znaku,
\item bit parzysto¶ci (obecny, nieobecny lub zanegowany),
\item ilo¶æ bitów stopu.
\end{itemize}
W transmisji synchronicznej, wspólny sygna³ zegarowy przesy³any jest
dodatkow± lini±, dziêki czemu zarówno odbiornik jak i nadajnik przesy³aj±
bity w jednakowych odstêpach czasu. Dane zgrupowane s± w bloki zwane
ramkami (ang. \emph{frame}). Ka¿d± ramkê rozpoczyna nag³ówek (rysunek
\ref{fig:Ramka-transmisji-szeregowej-synchr}), zawieraj±cy dodatkowe
informacje, np. ilo¶æ przesy³anych danych. Blok danych zawiera w³a¶ciwe
dane zgrupowane jeden za drugim. W celu zapewnienia poprawno¶ci transmisji,
s± one zakoñczone tzw. bajtami kontrolnymi i ewentualnymi bajtami
korekcyjnymi pozwalaj±cymi na naprawê uszkodzonych danych \cite{Krzyzanowski207}.

\begin{figure}
\begin{centering}
\includegraphics{rys/interfejsy/ramka_transmisji_szeregowej_synchronicznej}
\par\end{centering}

\caption{Ramka transmisji szeregowej synchronicznej (\emph{¬ród³o:} \cite{Krzyzanowski207})
\label{fig:Ramka-transmisji-szeregowej-synchr}}


\end{figure}



\subsection{Interfejsy typu \textit{master} -- \emph{slave}\label{sub:Interfejsy-typu-master}}

Jest to model komunikacji, w którym jedno z kilku urz±dzeñ pe³ni rolê
nadrzêdnego w stosunku do pozosta³ych. Urz±dzenie nadrzêdne nazywane
jest \emph{master}'em, podczas gdy pozosta³e uk³ady to \emph{slave}'y.
Rol± mastera jest kontrola ca³ego procesu komunikacji. Urz±dzenie
nadrzêdne inicjalizuje komunikacjê ze \emph{slave}'ami i kontroluje
ich dzia³anie. Jedynym typem danych przep³ywaj±cym w odwrotnym kierunku
s± odpowiedzi urz±dzeñ podrzêdnych na otrzymane zapytania. Interfejsy
tego typu s± powszechnie stosowane w technice ze wzglêdu na du¿± niezawodno¶æ
komunikacji i wzglêdn± prostotê dzia³ania. Przyk³adami tego typu komunikacji
mog± byæ interfejsy takie jak: SPI, I\textsuperscript{2}C, 1-Wire,
Modbus i wiele innych.


\section{Interfejs SPI}

Interfejs SPI (ang. \emph{Serial Peripheral Interface}) zosta³ zaprojektowany
i po raz pierwszy zastosowany przez firmê Motorola. Jest jednym z
najczê¶ciej u¿ywanych interfejsów miêdzy mikroprocesorami a~urz±dzeniami
zewnêtrznymi takimi jak przetworniki AD/DA, pamiêci EEPROM, czujniki
(akcelerometry, ¿yroskopy), pamiêci flash, sterowniki ekranów dotykowych
itp. W ¶wietle omówionych wcze¶niej cech interfejsów, SPI mo¿e byæ
scharakteryzowany jako:
\begin{itemize}
\item szeregowy,
\item synchroniczny,
\item komunikuj±cy siê w trybie \emph{full duplex},
\item przewodowy.
\end{itemize}
Komunikacja z urz±dzeniami wykonywana jest w oparciu o opisany w rozdziale
\ref{sub:Interfejsy-typu-master} model wymiany danych \emph{master}
- \emph{slave}. Do przesy³u danych wykorzystywane s± zwykle 4 przewody,
choæ interfejs mo¿e równie¿ funkcjonowaæ w postaci trójprzewodowej.
SPI jest standardem \emph{de facto}, tzn. jest powszechnie stosowany
przez wielu producentów sprzêtu elektronicznego, lecz w przeciwieñstwie
do standardu \emph{de jure} nie istnieje jego formalna specyfikacja
zaakceptowana przez komitety standaryzacyjne typu IEEE, ANSI lub ISO.
Interfejs SPI jest te¿ czasem okre¶lany jako czteroprzewodowa magistrala
szeregowa lub SSI (ang. \emph{Synchronous Serial Interface}).

Omawiany interfejs obejmuje cztery sygna³y:
\begin{itemize}
\item sygna³ zegarowy SCLK (wyj¶cie urz±dzenia\emph{ master}),
\item sygna³ MOSI (ang. \emph{Master Output Slave Input}) -- wyj¶cie urz±dzenia
\emph{master} i wej¶cie urz±dzenia \emph{slave},
\item sygna³ MISO (ang. \emph{Master Input Slave Output}) -- wej¶cie urz±dzenia
\emph{master} i wyj¶cie urz±dzenia \emph{slave},
\item sygna³ CS (ang. \emph{Chip Select}) lub SS (ang. \emph{Slave Select})
-- sygna³ wyboru urz±dzenia (wyj¶cie urz±dzenia \emph{master}).
\end{itemize}
Wymienione powy¿ej sygna³y posiadaj± tak¿e alternatywne nazwy:
\begin{itemize}
\item SCLK -- SCK, CLK,
\item MOSI -- SIMO, SDO, DO,
\item MISO -- SOMI, SDI, DI,
\item CS -- nCS, nSS, CSB, STE.
\end{itemize}

\subsection{Przesy³ danych}

\begin{figure}
\begin{centering}
\includegraphics{rys/interfejsy/spi_rejestry_przesuwne}
\par\end{centering}

\caption{Typowa realizacja transmisji SPI przy pomocy cyklicznego rejestru
przesuwnego (\emph{¬ród³o:} \cite{spi_am_gdynia}) \label{fig:spi-rej-przesuwny}}


\end{figure}


Przed dokonaniem transmisji danych, urz±dzenie \emph{master} musi
okre¶liæ odpowiedni± czêstotliwo¶æ sygna³u zegarowego. Nie mo¿e byæ
ona wiêksza od ¿adnej z maksymalnych dopuszczalnych czêstotliwo¶ci
wspieranych przez urz±dzenia \emph{slave}. Nastêpnie sygna³ wyboru
urz±dzenia (CS) przechodzi w stan aktywny (zwykle logiczne 0). Je¶li
nale¿y poczekaæ, aby wspó³pracuj±ce urz±dzenie podrzêdne dokona³o
przetwarzania danych (tak jest np. w przypadku przetworników analogowo-cyfrowych),
urz±dzenie nadrzêdne musi wstrzymaæ siê z generacj± sygna³u zegarowego.

Z ka¿dym taktem zegara zwi±zany jest cykl komunikacji \emph{full duplex}:
\begin{itemize}
\item urz±dzenie master wysy³a lini± MOSI kolejny bit, za¶ slave go odbiera,
\item urz±dzenie slave wysy³a kolejny bit danych lini± MISO, za¶ master
go odbiera.
\end{itemize}
W transmisji wykorzystywane s± zwykle dwa rejestry przesuwne (po jednym
dla urz±dzenia master i~slave) po³±czone ze sob± tworz±c rejestr
cykliczny (rysunek \ref{fig:spi-rej-przesuwny}). Zwykle wysy³any
jest najbardziej znacz±cy bit MSB (ang. \emph{most significant bit})
a odbierany najmniej znacz±cy LSB (ang. \emph{least significant bit}).
Po wype³nieniu rejestrów nastêpuje obróbka zawartych w nich danych,
tj. zapis do pamiêci, przetwarzanie itp. W celu wymiany wiêkszej ilo¶ci
informacji, wspomniany proces siê powtarza. W trakcie pojedynczego
cyklu komunikacji przesy³any jest zwykle bajt danych (8 bitów), choæ
nie jest to regu³±; istniej± uk³ady w których przesy³a siê 12 lub
16 bitów. Niektóre urz±dzenia \emph{slave} nie pozwalaj± na odbieranie
danych w ci±gu wiêkszej od zadanej liczby taktów sygna³u zegarowego;
w innych rozwi±zaniach konstrukcyjnych dane nadmiarowe s± ignorowane.

Oprócz wymienionych sygna³ów steruj±cych komunikacj±, w urz±dzeniu
\emph{slave} mo¿liwe jest równie¿ wyprowadzenie sygna³u przerwania.
Przyk³adowo mo¿e to byæ sygna³ informuj±cy o dotkniêciu ekranu dotykowego,
sygna³ alarmowy generowany przez czujnik temperatury lub zegar czasu
rzeczywistego. Standard SPI nie przewiduje u¿ycia przerwañ, chocia¿
przeznaczanie dla nich oddzielnego pinu w~urz±dzeniu \emph{slave}
nie jest ani zakazane ani obowi±zkowe.

¯adne z urz±dzeñ \emph{slave}, które nie zosta³o aktywowane sygna³em
CS nie powinno reagowaæ na sygna³ taktuj±cy ani sterowaæ wspóln± magistral±.
Urz±dzenie \emph{master}, wybiera za¶ do wymiany informacji tylko
jedno urz±dzenie podrzêdne.


\subsection{Faza i polaryzacja sygna³u zegarowego}

\begin{figure}
\begin{centering}
\includegraphics{rys/interfejsy/spi_pol_faza}
\par\end{centering}

\caption{Przebiegi odpowiadaj±ce ró¿nym polaryzacjom i fazom sygna³u taktuj±cego
(\emph{¬ród³o:} \cite{spi_pol_ph})}


\end{figure}


Poza okre¶leniem czêstotliwo¶ci sygna³u taktuj±cego, urz±dzenie nadrzêdne
musi tak¿e zdefiniowaæ polaryzacjê i fazê tego sygna³u. Zwykle jest
to zwi±zane z wpisaniem do odpowiednich rejestrów konfiguracyjnych
warto¶ci 0 lub 1 na odpowiednich pozycjach. Bity na tych pozycjach
zwykle nazywane s± CPOL (dla okre¶lenia polaryzacji) oraz CPHA (dla
okre¶lenia fazy); ich znaczenie jest nastêpuj±ce:
\begin{itemize}
\item je¶li CPOL = 0, to stanem nieaktywnym sygna³u zegara jest stan niski
oraz:

\begin{itemize}
\item je¶li CPHA = 0, to dane zapisywane s± przy zboczu narastaj±cym zegara,
za¶ przesy³ane przy opadaj±cym,
\item je¶li CPHA = 1, to dane zapisywane s± przy zboczu opadaj±cym zegara,
za¶ przesy³ane przy narastaj±cym,
\end{itemize}
\item je¶li CPOL = 1, to stanem nieaktywnym sygna³u taktuj±cego jest stan
wysoki oraz:

\begin{itemize}
\item je¶li CPHA = 0, to dane zapisywane s± przy zboczu opadaj±cym zegara,
za¶ przesy³ane przy narastaj±cym,
\item je¶li CPHA = 1, to dane zapisywane s± przy zboczu narastaj±cym zegara,
za¶ przesy³ane przy opadaj±cym.
\end{itemize}
\end{itemize}

\subsection{Wspó³praca z kilkoma urz±dzeniami podrzêdnymi}

Jak wspomniano wcze¶niej, interfejs SPI pozwala na wspó³pracê jednego
urz±dzenia nadrzêdnego z kilkoma urz±dzeniami \emph{slave}. Jednym
ze sposobów zorganizowania takiego uk³adu transmisji danych jest zastosowanie
niezale¿nych sygna³ów CS dla ka¿dego z urz±dzeñ podrzêdnych. Przyk³ad
takiego rozwi±zania pokazano na rysunku \ref{fig:spi-independent-slaves}.
Poniewa¿ wszystkie wyj¶cia MISO uk³adów \emph{slave} s± po³±czone
do wspólnej linii, powinny byæ one wyj¶ciami trójstanowymi.

\begin{figure}
\begin{centering}
\includegraphics{rys/interfejsy/spi_independent_slaves}
\par\end{centering}

\caption{Typowa realizacja komunikacji przy pomocy interfejsu SPI z wieloma
urz±dzeniami \emph{slave} (\emph{¬ród³o:} \cite{spi_independent_slaves})
\label{fig:spi-independent-slaves}}


\end{figure}


Niektóre urz±dzenia wspieraj±ce SPI s± zaprojektowane z my¶l± o zastosowaniu
po³±czenia ³añcuchowego (znanego w literaturze anglojêzycznej jako
\emph{daisy chain}). W takiej konfiguracji wyj¶cie jednego z~urz±dzeñ
\emph{slave} jest po³±czone do wej¶cia drugiego \emph{slave'a} itd.
Port SPI takiego urz±dzenia podrzêdnego w danym cyklu transmisji odbiera
dane od poprzedniego urz±dzenia, które te same dane odebra³o w poprzednim
cyklu. Ca³a kaskada dzia³a jak jeden du¿y rejestr przesuwny. Zalet±
takiego rozwi±zania jest to, ¿e urz±dzenie typu \emph{master} mo¿e
wykorzystywaæ tylko jeden sygna³ CS.

\begin{figure}
\begin{centering}
\includegraphics{rys/interfejsy/spi_daisy_chain}
\par\end{centering}

\caption{Komunikacja przy pomocy interfejsu SPI w konfiguracji \emph{daisy
chain} (\emph{¬ród³o:} \cite{spi_daisy_chain})}


\end{figure}



\subsection{Zalety i wady interfejsu SPI}

Do zalet interfejsu SPI mo¿emy zaliczyæ:
\begin{itemize}
\item komunikacja w trybie \emph{full duplex},
\item ilo¶æ przesy³anych danych nie jest ograniczona do 8 bitów,
\item prosty do zrozumienia i implementacji protokó³,
\item stosunkowo prosta budowa:

\begin{itemize}
\item relatywnie ma³o skomplikowane obwody elektryczne, mniejsze zu¿ycie
energii,
\item urz±dzenia \emph{slave} u¿ywaj± wspólnego sygna³u zegarowego generowanego
przez uk³ad \emph{master} (dodatkowe precyzyjne oscylatory i pêtle
PLL s± niepotrzebne),
\item urz±dzenia slave nie wymagaj± unikalnych adresów (w przeciwieñstwie
do I2C, GPIB czy SCSI),
\item nie s± wymagane transceivery,
\end{itemize}
\item wystarczaj± tylko 4 piny,
\item wiêkszo¶æ linii sygna³owych mo¿e byæ wspó³dzielonych przez ró¿ne urz±dzenia
\emph{slave}.
\end{itemize}
W¶ród wad interfejsu SPI mo¿na wymieniæ:
\begin{itemize}
\item wiêksz± w porównaniu do I\textsuperscript{2}C ilo¶æ pinów obudowy
IC,
\item brak sprzêtowej kontroli przep³ywu danych przez urz±dzenia \emph{slave},
\item brak sprzêtowego potwierdzania obecno¶ci urz±dzenia \emph{slave} (\emph{master}
mo¿e ,,rozmawiaæ'' z niczym),
\item brak wsparcia dla architektury multi-master,
\item brak oficjalnego standardu,
\item brak protoko³u obs³ugi b³êdów,
\item brak wsparcia dla dynamicznego pod³±czania urz±dzeñ \emph{slave},
\item dzia³anie na stosunkowo niedu¿e odleg³o¶ci.
\end{itemize}

\subsection{Zastosowania}

Du¿o mniejsza w porównaniu z interfejsami równoleg³ymi liczba niezbêdnych
pinów powoduje, ¿e SPI jest bardzo czêsto wykorzystywany w systemach
wbudowanych. Jest on elementem wielu mikrokontrolerów z rodziny ARM,
AVR, PIC oraz MSP. Niektóre mikrokontrolery AVR mog± byæ programowane
z u¿yciem interfejsu SPI. Czêsto u¿ywa siê go tak¿e do komunikacji
z takimi uk³adami peryferyjnymi jak:
\begin{itemize}
\item czujniki temperatury, ci¶nienia, przyspieszenia,
\item przetworniki ADC oraz DAC,
\item kontrolery ekranów dotykowych oraz gier,
\item pamiêci flash oraz EEPROM,
\item zegary RTC,
\item karty MMC oraz SD.
\end{itemize}

\section{Interfejs UART\label{sec:Interfejs-UART}}

UART (ang. \emph{Universal Asynchronous Receiver and Transmitter})
jest protoko³em umo¿liwiaj±cym asynchroniczne odbieranie i nadawanie
informacji przy pomocy portu szeregowego. Sk³ada siê z trzech zasadniczych
elementów:
\begin{itemize}
\item konwertera równoleg³o-szeregowego (ang. \emph{parallel to serial}),
pozwalaj±cego na przesy³anie danych z komputera,
\item konwertera szeregowo-równoleg³ego, umo¿liwiaj±cego odbiór danych pochodz±cych
z komputera przez urz±dzenie zewnêtrzne,
\item bufora danych, s³u¿±cego do tymczasowego przechowywania danych w przypadku
szybkiej transmisji.
\end{itemize}
UART u¿ywany jest czêsto w po³±czeniu z takim standardami komunikacyjnymi
jak RS-232, EIA czy RS-485. Jego uniwersalno¶æ polega na tym, ¿e szybko¶æ
transmisji oraz format danych s± konfigurowalne. Poziomy elektryczne
sygna³ów elektrycznych oraz ich postaæ (np. sygna³ ró¿nicowy) ustawiane
s± przez zewnêtrzny uk³ad sterownika. Omawiane urz±dzenia wystêpuj±
jako uk³ady scalone (b±d¼ ich komponenty) bêd±ce sk³adnikami mikrokontrolerów.
Istniej± konstrukcje ³±cz±ce dwa (DUART) lub osiem uk³adów UART w
jednej obudowie. Istniej± równie¿ chipy pozwalaj±ce na komunikacjê
synchroniczn±, okre¶lane w skrócie jako USART (ang. \emph{Universal
Synchronous and Asynchronous Receiver and Transmitter}).


\subsection{Transmisja}

Uniwersalny asynchroniczny odbiornik/nadajnik przesy³a bajty danych
bit po bicie. UART znajduj±cy siê po drugiej stronie odbiera poszczególne
bity ³±cz±c je w bajty. Konwersjê z równoleg³ej postaci danych na
szeregow± uzyskuje siê zwykle przy pomocy rejestrów przesuwnych bêd±cych
sk³adnikami UARTów. U¿ycie szeregowej transmisji danych zamiast równoleg³ej
(bardziej naturalnej dla urz±dzeñ cyfrowych) pozwala na zmniejszenie
kosztów oraz problemów zwi±zanych z zak³óceniami elektromagnetycznymi.

UART zwykle nie generuje ani nie odbiera bezpo¶rednio sygna³ów odpowiedzialnych
za komunikacjê. W tym celu u¿ywa siê dodatkowych interfejsów, konwertuj±cych
sygna³y u¿ywane przez UART na w³a¶ciwe przebiegi odpowiadaj±ce za
transmisjê danych. Czêsto u¿ywanymi standardami s± RS-232, RS-485
oraz EIA. Komunikacja mo¿e odbywaæ siê w trybie \emph{simplex}, \emph{half
duplex} oraz \emph{full duplex}.


\subsection{Ramka danych}

\begin{figure}
\begin{centering}
\includegraphics{rys/interfejsy/ramka_uart}
\par\end{centering}

\caption{Ramka danych wysy³ana lub odbierana przez UART \label{fig:Ramka-danych-uart}}


\end{figure}


Rysunek \ref{fig:Ramka-danych-uart} przedstawia typow± ramkê u¿ywane
w trakcie transmisji przy pomocy uk³adu UART. W stanie bezczynno¶ci
(gdy nie przesy³ane s± ¿adne dane), linia danych jest zwykle w stanie
wysokim. Wysy³anie w³a¶ciwych danych (zwanych znakiem) sygnalizowane
jest bitem startu, tj. przej¶ciem linii danych do stanu niskiego.
Przesy³any znak sk³ada siê zazwyczaj z 5 - 8 bitów. W celu zapewnienia
kontroli poprawno¶ci danych, mo¿e byæ zakoñczony tzw. bitem parzysto¶ci.
W celu zasygnalizowania odbiornikowi zakoñczenia transmisji, przesy³any
jest bit stopu, który mo¿e byæ zdublowany.


\subsection{Odbiór danych}

Wszystkie operacje w uk³adzie UART sterowane s± sygna³em zegarowym
o czêstotliwo¶ci bêd±cej wielokrotno¶ci± czêsto¶ci u¿ywanej do przesy³ania
danych. Odbiornik próbkuje liniê danych w oczekiwaniu na pojawienie
siê bitu startu. Je¶li linia danych przejdzie ze stanu spoczynkowego
do aktywnego na czas wynosz±cy co najmniej po³owê okresu trwania bitu,
zostanie to zinterpretowane jako bit startu. W~przeciwnym wypadku
zarejestrowany impuls zostanie zignorowany. Nastêpnie po up³ywie niewielkiego
czasu nastêpuje dalsze próbkowanie linii danych po³±czone z wczytywaniem
znaku do odbiorczego rejestru przesuwnego. Po wczytaniu okre¶lonej
liczby bitów, UART ustawia odpowiedni± flagê lub generuje sygna³ przerwania
informuj±cy mikroprocesor o odebraniu danych.

Komunikuj±ce siê uk³ady UART nie posiadaj± wspólnego sygna³u zegarowego.
Ka¿dy z nich posiada w³asne zegary, których synchronizacja dokonuje
siê w oparciu o sygna³ na linii danych. Zwykle synchronizacja ma miejsce
w chwili zmiany stanu linii danych, o ile zmiana ta mo¿e byæ uznana
za wa¿n±. Uproszczone uk³ady synchronizuj± siê w momencie detekcji
opadaj±cego zbocza bitu startu, za¶ odczyt kolejnych bitów nastêpuje
w po³owach czasów ich trwania. Takie rozwi±zanie dzia³a poprawnie,
o ile szybko¶æ transmisji pozwala na poprawny odczyt bitów stopu.

Standardow± cech± uk³adów UART jest pobieranie kolejnego znaku, gdy
poprzedni zosta³ zapisany w rejestrze. Zastosowane w ten sposób podwójne
buforowanie pozwala mikroprocesorowi na odczyt poprzedniego znaku,
przed odebraniem nastêpnego. Je¶li centralna jednostka przetwarzaj±ca
po stronie odbiornika potrzebuje jeszcze wiêcej czasu na odbiór, mo¿na
zastosowaæ buforowanie danych z u¿yciem kolejek FIFO.


\subsection{Nadawanie danych}

Po umieszczeniu znaku w rejestrze przesuwnym nadajnika, UART wysy³a
na liniê danych bit startu, kolejne bity danych, bit parzysto¶ci (je¶li
jest u¿ywany) oraz bit (lub dwa bity) stopu. Poniewa¿ transmisja pojedynczego
znaku zajmuje pewien czas, uk³ad nadawczy ustawia odpowiedni± flagê
zajêto¶ci, która informuje mikroprocesor, ¿eby nie umieszcza³ kolejnego
znaku w rejestrze przesuwnym. Zamiast flagi mo¿e byæ wygenerowane
odpowiednie przerwanie. W przypadku trybu \emph{full duplex} oba uk³ady
UART u¿ywaj± dwóch rejestrów przesuwnych.


\subsection{W³asno¶ci}

Oba uk³ady UART, zarówno nadawczy jak i odbiorczy musz± mieæ zgodne
nastêpuj±ce parametry:
\begin{itemize}
\item szybko¶æ transmisji danych,
\item ilo¶æ bitów danych,
\item obecno¶æ (lub jej brak) bitu parzysto¶ci,
\item ilo¶æ bitów stopu.
\end{itemize}
W przypadku niezgodno¶ci ww. parametrów, uk³ad odbiorczy mo¿e ustawiæ
odpowiedni± flagê b³êdu. Typowo porty szeregowe komputerów wykorzystuj±
osiem bitów danych, bit parzysto¶ci i jeden bit stopu.


\subsection{Transmisja w trybie synchronicznym}

Jak wspomniano wcze¶niej istniej± uk³ady typu USART potrafi±ce tak¿e
pracowaæ w trybie transmisji synchronicznej. W tym wypadku przebieg
sygna³u zegarowego jest pozyskiwany na podstawie sygna³u na linii
danych. Dziêki obecno¶ci sygna³u synchronizacyjnego niepotrzebne staj±
siê bity startu i~stopu, co pozwala na lepsze wykorzystanie linii
danych i w efekcie bardziej efektywn± komunikacjê. W~przypadku trybu
asynchronicznego, gdy nie ma danych do przes³ania, linia danych znajduje
siê w stanie spoczynku. W trybie transmisji synchronicznej konieczne
jest przesy³anie specjalnych znaków w celu utrzymania synchronizacji.


\subsection{Stany b³êdne}

Poni¿ej opisano mo¿liwe b³êdy towarzysz±ce komunikacji z wykorzystaniem
urz±dzeñ UART.
\begin{itemize}
\item B³±d przepe³nienia (ang. \emph{overrun error}) -- wystêpuje, gdy odbiorca
nie mo¿e przetworzyæ jednej porcji danych przed pojawieniem siê kolejnej.
Ró¿ne urz±dzenia dysponuj± ró¿nymi pojemno¶ciami buforów s³u¿±cych
do przechowywania odebranych danych. Jednostka przetwarzaj±ca dane
musi to robiæ na tyle szybko, aby zwolniæ miejsce dla kolejnych znaków
-- w przeciwnym razie dochodzi do nadpisania nie przetworzonych jeszcze
informacji.
\item B³±d niedope³nienia (ang. \emph{underrun error}) -- ma miejsce, gdy
po wys³aniu danych przez nadajnik, bufor nadawczy jest pusty. W trybie
asynchronicznym sytuacja taka traktowana jest raczej jako brak danych
do wys³ania ni¿ stan b³êdny. W trybie synchronicznym jest to powa¿ny
b³±d.
\item B³±d ramki (ang. \emph{framing error}) -- pojawia siê, gdy bity startu
i stopu nie s± wykrywane. Bit startu sygnalizuj±cy pocz±tek znaku
stanowi odniesienie dla pozosta³ych bitów. Je¶li linia danych nie
znajdzie siê we w³a¶ciwym stanie, gdy spodziewany jest bit stopu sygnalizowany
jest b³±d ramki.
\item B³±d parzysto¶ci (ang. \emph{parity error}) -- wystêpuje, gdy liczba
jedynek w przesy³anym znaku wraz z~bitem parzysto¶ci jest liczb±
parzyst±. Istnienie omawianego bitu w ramce jest opcjonalne.\end{itemize}

